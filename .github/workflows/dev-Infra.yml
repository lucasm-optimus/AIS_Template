name: Tilray-Infra-dev
on:
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION: bcdf2f15-1f15-49b0-8ba7-c4fb87a2fc20
  AZURE_RESOURCE_GROUP: rg-tilray-it-dev-cace
  ENVIRONMENT: dev
  TEMPLATE_FILE_PATH: ./Infra/main.bicep
  PARAMETERS_FILE_PATH: ./Infra/dev.params.json

jobs:

  bicep-linter:
    runs-on: ubuntu-latest
    steps:
      # Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

      # Log into Azure
    - name: Log into Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

        
      # bicep linter
    - name: Bicep Linter
      uses: azure/CLI@v2
      with:
        azcliversion: 2.63.0
        inlineScript: |
          az bicep install
          az bicep upgrade
          az bicep lint --file ${{ env.TEMPLATE_FILE_PATH }}

  what-if:
    needs: bicep-linter
    runs-on: ubuntu-latest
    steps:
      # Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

      # Log into Azure
    - name: Log into Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      # What-If step
    - name: Run What-If
      run: |
        az bicep install
        az deployment group what-if --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --template-file ${{ env.TEMPLATE_FILE_PATH }} --parameters ${{ env.PARAMETERS_FILE_PATH }}

  approval:
    needs: what-if
    runs-on: ubuntu-latest
    environment:
      name: ${{ env.ENVIRONMENT }}
    steps:
      - name: Approval Required
        run: echo "Waiting for approval to proceed with deployment..."

  deploy:
    needs: approval
    runs-on: ubuntu-latest
    steps:
      # Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

      # Log into Azure
    - name: Log into Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      # Deploy Bicep file
    - name: Deploy
      uses: azure/arm-deploy@v1
      with:
        scope: resourceGroup
        subscriptionId: ${{ env.AZURE_SUBSCRIPTION }}
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ${{ env.TEMPLATE_FILE_PATH }}
        parameters: ${{ env.PARAMETERS_FILE_PATH }}
        failOnStdErr: false
        deploymentMode: 'Incremental'